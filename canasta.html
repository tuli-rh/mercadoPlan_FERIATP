<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Mi Canasta — MercaPlan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">MercaPlan</a>
            <a class="btn btn-outline-primary ms-auto" href="productos.html">Agregar más</a>
        </div>
    </nav>

    <main class="container py-4">
        <h4 class="mb-3">Mi Canasta</h4>
        <div id="items" class="row g-3 mb-4"></div>

        <div class="d-flex align-items-center mb-2">
            <h5 class="me-2 mb-0">Totales por supermercado</h5>
            <span class="small text-muted">· se calcula con el precio disponible de cada producto en cada tienda</span>
        </div>
        <ul id="totals" class="list-group mb-3"></ul>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-danger" onclick="clearBasket()">Vaciar canasta</button>
            <button class="btn btn-outline-secondary" onclick="exportCSV()">Exportar CSV</button>
        </div>
    </main>

    <script src="./static/js/app.js"></script>
    <script src="./static/js/normalize.js"></script>
    <script src="./static/js/basket.js"></script>
    <script>
        (async () => {
            const { products, stores, prices } = await loadAllData();
            const ids = getBasket();
            const cont = document.getElementById('items');

            if (!ids.length) {
                cont.innerHTML = `<div class="col-12"><div class="alert alert-info">Tu canasta está vacía.</div></div>`;
            } else {
                cont.innerHTML = '';
            }

            ids.forEach(pid => {
                const p = products.find(x => x.id === pid);
                cont.insertAdjacentHTML('beforeend', `
      <div class="col-12 col-md-6">
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex align-items-center gap-3">
            <img src="${p.image}" width="64" height="64" class="rounded border object-fit-contain">
            <div class="flex-grow-1">
              <div class="fw-semibold">${p.brand}</div>
              <div class="small text-muted">${p.name}</div>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFromBasket('${p.id}', true)">Quitar</button>
          </div>
        </div>
      </div>`);
            });

            // Totales por tienda (suma del precio final del producto en esa tienda si existe)
            const totals = Object.fromEntries(stores.map(s => [s.id, 0]));

            ids.forEach(pid => {
                stores.forEach(s => {
                    const option = prices.find(x => x.product_id === pid && x.store_id === s.id);
                    if (option) {
                        totals[s.id] += applyPromo(option);
                    }
                });
            });

            const ul = document.getElementById('totals'); ul.innerHTML = '';
            stores
                .map(s => ({ id: s.id, name: s.name, total: totals[s.id] }))
                .sort((a, b) => a.total - b.total)
                .forEach(row => {
                    ul.insertAdjacentHTML('beforeend', `
        <li class="list-group-item d-flex justify-content-between">
          <span>${row.name}</span><strong>${clp(row.total)}</strong>
        </li>`);
                });

            // Export CSV
            window.exportCSV = () => {
                let csv = 'Producto,Marca,Supermercado,Precio Final (CLP)\n';
                ids.forEach(pid => {
                    const p = products.find(x => x.id === pid);
                    stores.forEach(s => {
                        const option = prices.find(x => x.product_id === pid && x.store_id === s.id);
                        if (option) {
                            csv += `"${p.name.replace(/"/g, '""')}",${p.brand},${s.name},${applyPromo(option)}\n`;
                        }
                    });
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `mercaplan_canasta.csv`;
                a.click();
            }
        })();
    </script>
</body>

</html>
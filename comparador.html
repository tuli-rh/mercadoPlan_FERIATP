<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Comparador — MercaPlan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">MercaPlan</a>
            <a class="btn btn-primary ms-auto" href="canasta.html">Mi Canasta</a>
        </div>
    </nav>

    <main class="container py-4">
        <div id="productHead" class="mb-3"></div>
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Supermercado</th>
                        <th>Precio</th>
                        <th>Precio/ud</th>
                        <th>Promo</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="rows"></tbody>
            </table>
        </div>
    </main>

    <script src="./static/js/app.js"></script>
    <script src="./static/js/normalize.js"></script>
    <script src="./static/js/basket.js"></script>
    <script>
        (async () => {
            const id = new URL(location.href).searchParams.get('id');
            const { products, stores, prices } = await loadAllData();
            const product = products.find(p => p.id === id);

            if (!product) {
                document.getElementById('productHead').innerHTML = '<div class="alert alert-warning">Producto no encontrado</div>';
                return;
            }

            document.getElementById('productHead').innerHTML = `
    <div class="d-flex gap-3 align-items-center">
      <img src="${product.image}" width="80" height="80" class="rounded border object-fit-contain">
      <div>
        <h5 class="mb-0">${product.brand}</h5>
        <div class="text-muted">${product.name} — <span class="badge text-bg-secondary">${product.category}</span></div>
      </div>
      <button class="btn btn-primary ms-auto" onclick="addToBasket('${product.id}')">Agregar a Mi Canasta</button>
    </div>`;

            const list = prices.filter(p => p.product_id === product.id);
            const tbody = document.getElementById('rows');
            tbody.innerHTML = '';

            // ordenar por precio final ascendente
            const withCalc = list.map(item => {
                const final = applyPromo(item);
                const unit = unitPrice(final, product.normalized);
                return { item, final, unit };
            }).sort((a, b) => a.final - b.final);

            withCalc.forEach(({ item, final, unit }) => {
                const store = stores.find(s => s.id === item.store_id);
                tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="fw-semibold">${store?.name ?? item.store_id}</td>
        <td>${clp(final)}</td>
        <td>${formatUnit(unit, product.normalized.unit)}</td>
        <td>${promoLabel(item.promo)}</td>
        <td><a class="btn btn-sm btn-outline-secondary" href="${item.url}" target="_blank" rel="noopener">Ver</a></td>
      </tr>`);
            });
        })();
    </script>
</body>

</html>